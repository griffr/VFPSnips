CLOSE DATABASES ALL
LOCAL LLDOC,LLACCOUNT,LLSTOCK,LLQUAN,LLPRICE,LLDISC,LLVATPCT,LLCFACT,LLDISCITM,LLDISCVAL,LLEXVAT,LLLINEVAL,LLVATVAL


USE IN A "D:\Data\COMP_H\H_ihead.DBF" ALIAS IHEAD
USE IN B "D:\Data\COMP_H\H_itran.DBF" ALIAS ITRAN
USE "D:\Data\COMP_H\H_cname.dbf" ALIAS COMPONENT IN 0 ORDER CNAME1
USE "D:\Data\COMP_H\H_cfact.dbf" ALIAS ASSEMBLYFACT IN 0 ORDER CFACT1
SELECT COMPONENT
SET RELATION TO CN_FACT INTO ASSEMBLYFACT ADDITIVE

SELECT B
SET FILTER TO ALLTRIM(IT_NUMINV)=="" AND ALLTRIM(IT_STATUS)="A" AND !EMPTY(ALLTRIM(IT_STOCK)) AND !DELETED() AND ALLTRIM(IT_STOCK) != "POST AND PACKING"
SCAN
	LLDOC = ALLTRIM(ITRAN.IT_DOC)
	LLSTOCK = ALLTRIM(ITRAN.IT_STOCK)
	LLQUAN = ITRAN.IT_QUAN
	LLPRICE = ITRAN.IT_PRICE
	LLDISC = ITRAN.IT_DISC
	LLVATPCT = ITRAN.IT_VATPCT
	SELECT IH_DOC, IH_ACCOUNT FROM IHEAD WHERE ALLTRIM(IH_DOC) = ALLTRIM(LLDOC) INTO CURSOR CURIHEAD
	LLACCOUNT = CURIHEAD.IH_ACCOUNT


	*?
	*?LLACCOUNT + "  ::  " + LLDOC + "  ::  " + LLSTOCK

	SELECT * FROM COMPONENT WHERE ALLTRIM(COMPONENT.CN_REF) == ALLTRIM(LLSTOCK) INTO CURSOR CURCOMPONENT
	LLPRICE = CURCOMPONENT.CN_SELL
	LLCFACT=ASSEMBLYFACT.CF_DPS
	LLDISCITM = (LLPRICE * LLDISC)/100
	LLDISCVAL = (LLDISCITM * (LLQUAN/10**LLCFACT))

	*?"LLQUAN: " + TRANSFORM(LLQUAN) + "  ::  LLPRICE: " + TRANSFORM(LLPRICE) + "  ::  LLDISC: " + TRANSFORM(LLDISC)
	*?"llcfact: " + TRANSFORM(LLCFACT) + "  ::  lldiscitm: " + TRANSFORM(LLDISCITM) + "  ::  lldiscval: " + TRANSFORM(LLDISCVAL)

	LLEXVAT = (LLPRICE - LLDISCITM)*(LLQUAN/10**LLCFACT)

	LLLINEVAL = LLEXVAT + ((LLEXVAT/100)*LLVATPCT)

	LLVATVAL = ((LLEXVAT/100)*LLVATPCT)
	*?"llexvat: " + TRANSFORM(LLEXVAT)
	*?"llvatval: " + TRANSFORM(LLVATVAL)
	*?"lllineval: " + TRANSFORM(LLLINEVAL)
	SELECT B
	REPLACE IT_EXVAT WITH LLEXVAT
	REPLACE IT_PRICE WITH LLPRICE
	REPLACE IT_LINEVAL WITH LLLINEVAL
	REPLACE IT_DISCVAL WITH LLDISCVAL
	REPLACE IT_VATVAL WITH LLVATVAL


	
ENDSCAN
?FIN
*!*	USE IN a "D:\Data\COMP_H\H_ihead.DBF" ALIAS ihead
*!*	SET FILTER TO ih_docstat='O' AND ALLTRIM(ih_invoice) == ""
*!*	BROWSE NOCAPTIONS
*!*	SCAN
*!*		lldoc = ihead.ih_doc
*!*		llaccount = ihead.ih_account
*!*		?lldoc + " :: " + llaccount
*!*		USE IN b "D:\Data\COMP_H\H_itran.DBF" ALIAS itran
*!*		SELECT b
*!*		SET FILTER TO ALLTRIM(it_doc) = ALLTRIM(lldoc) AND ALLTRIM(it_status)="A"
*!*
*!*
*!*
*!*	ENDSCAN
